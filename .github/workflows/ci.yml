name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: gradle

      - name: Run tests with coverage
        run: ./gradlew --no-daemon clean test jacocoTestReport

      - name: Publish coverage summary
        if: always()
        run: |
          REPORT="build/reports/jacoco/test/jacocoTestReport.xml"

          if [ ! -f "$REPORT" ]; then
            {
              echo "## Test Coverage"
              echo
              echo "Coverage report was not generated (tests likely failed before JaCoCo report task completed)."
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          LINE_VALUES=$(awk -F'"' '/<counter type="LINE"/ {print $4" "$6; exit}' "$REPORT")
          BRANCH_VALUES=$(awk -F'"' '/<counter type="BRANCH"/ {print $4" "$6; exit}' "$REPORT")

          LINE_MISSED=$(echo "$LINE_VALUES" | awk '{print $1+0}')
          LINE_COVERED=$(echo "$LINE_VALUES" | awk '{print $2+0}')
          LINE_TOTAL=$((LINE_MISSED + LINE_COVERED))

          if [ "$LINE_TOTAL" -eq 0 ]; then
            LINE_PERCENT="0.00"
          else
            LINE_PERCENT=$(awk -v c="$LINE_COVERED" -v t="$LINE_TOTAL" 'BEGIN { printf "%.2f", (c*100)/t }')
          fi

          if [ -n "$BRANCH_VALUES" ]; then
            BRANCH_MISSED=$(echo "$BRANCH_VALUES" | awk '{print $1+0}')
            BRANCH_COVERED=$(echo "$BRANCH_VALUES" | awk '{print $2+0}')
            BRANCH_TOTAL=$((BRANCH_MISSED + BRANCH_COVERED))
            if [ "$BRANCH_TOTAL" -eq 0 ]; then
              BRANCH_PERCENT="0.00"
            else
              BRANCH_PERCENT=$(awk -v c="$BRANCH_COVERED" -v t="$BRANCH_TOTAL" 'BEGIN { printf "%.2f", (c*100)/t }')
            fi
          else
            BRANCH_PERCENT="n/a"
            BRANCH_COVERED=0
            BRANCH_TOTAL=0
          fi

          {
            echo "## Test Coverage"
            echo
            echo "| Metric | Covered | Total | Coverage |"
            echo "|---|---:|---:|---:|"
            echo "| Line | $LINE_COVERED | $LINE_TOTAL | $LINE_PERCENT% |"
            echo "| Branch | $BRANCH_COVERED | $BRANCH_TOTAL | $BRANCH_PERCENT% |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-html-report
          path: build/reports/jacoco/test/html

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            build/reports/tests/test
            build/test-results/test
